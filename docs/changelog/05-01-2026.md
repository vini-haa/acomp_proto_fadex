# Relatório de Alterações - 05/01/2026

## Resumo Executivo

Implementação de melhorias baseadas na análise de trace SQL do sistema SAGI, focando em:

- Detecção e monitoramento de protocolos estagnados
- Novos filtros avançados para listagem de protocolos
- Endpoint de estatísticas de qualidade de dados
- Identificação de setores desabilitados com protocolos pendentes

---

## 1. Novo Endpoint: Protocolos Estagnados

### Arquivo Criado

`app/api/protocolos/estagnados/route.ts`

### Rota

`GET /api/protocolos/estagnados`

### Parâmetros

| Parâmetro    | Tipo    | Padrão | Descrição                            |
| ------------ | ------- | ------ | ------------------------------------ |
| `diasMinimo` | number  | 365    | Mínimo de dias sem movimentação      |
| `setor`      | number  | -      | Filtrar por código do setor atual    |
| `limit`      | number  | 100    | Limite de registros (máx: 1000)      |
| `resumo`     | boolean | false  | Se true, retorna apenas estatísticas |

### Resposta (resumo=true)

```json
{
  "data": {
    "totalEstagnados": 66084,
    "totalMais365Dias": 66087,
    "totalMais180Dias": 96706,
    "totalMais90Dias": 108988,
    "mediaDiasSemMovimentacao": 1250,
    "porSetor": [...],
    "porFaixa": [
      { "faixa": "01. Menos de 3 meses", "quantidade": ... },
      { "faixa": "02. 3-6 meses", "quantidade": ... },
      { "faixa": "03. 6-12 meses", "quantidade": ... },
      { "faixa": "04. 1-2 anos", "quantidade": ... },
      { "faixa": "05. Mais de 2 anos", "quantidade": ... }
    ]
  }
}
```

### Resultado do Teste

- **66.084 protocolos** identificados como estagnados (>365 dias sem movimentação)

---

## 2. Novos Filtros no Endpoint de Protocolos

### Arquivo Modificado

`lib/queries/filter-builder.ts`

### Novos Filtros Disponíveis

| Filtro                 | Tipo    | Descrição                                        |
| ---------------------- | ------- | ------------------------------------------------ |
| `setorAtual`           | number  | Código do setor onde o protocolo está atualmente |
| `setorOrigem`          | number  | Código do setor de origem/criação                |
| `diasEstagnado`        | number  | Mínimo de dias sem movimentação                  |
| `apenasEstagnados`     | boolean | Filtrar apenas protocolos estagnados (>365 dias) |
| `excluirLotePagamento` | boolean | Excluir LOTE DE PAGAMENTOS (padrão: true)        |
| `assuntoNormalizado`   | string  | Filtrar por categoria/rubrica orçamentária       |

### Exemplo de Uso

```bash
# Protocolos estagnados no setor Jurídico (código 5)
GET /api/protocolos?apenasEstagnados=true&setorAtual=5

# Protocolos incluindo LOTE DE PAGAMENTOS
GET /api/protocolos?excluirLotePagamento=false
```

### Arquivos Atualizados

- `lib/queries/filter-builder.ts` - Lógica dos novos filtros
- `lib/schemas/protocolos.ts` - Schemas Zod atualizados
- `app/api/protocolos/route.ts` - Extração dos novos parâmetros

---

## 3. Novo Endpoint: Estatísticas de Qualidade de Dados

### Arquivo Criado

`app/api/admin/qualidade-dados/route.ts`

### Rota

`GET /api/admin/qualidade-dados`

### Métricas Retornadas

#### Totais Gerais

| Métrica                | Valor Atual |
| ---------------------- | ----------- |
| Total de Protocolos    | 203.054     |
| Total de Movimentações | 290.332     |

#### Situação dos Protocolos (codSituacaoProt)

| Métrica                  | Valor            |
| ------------------------ | ---------------- |
| Sem Situação (NULL)      | 111.898 (38.54%) |
| Com Situação             | 178.434          |
| Código 0 (Sem Descrição) | 142.427 (49.06%) |

#### Estatísticas de Estagnação

| Faixa     | Quantidade | % do Total |
| --------- | ---------- | ---------- |
| >365 dias | 66.087     | 53.5%      |
| >180 dias | 96.706     | -          |
| >90 dias  | 108.988    | -          |

#### Setores

| Métrica                | Valor |
| ---------------------- | ----- |
| Total de Setores       | 56    |
| Setores Ativos         | 15    |
| Setores Desabilitados  | 41    |
| Setores com Protocolos | 38    |

#### Dados Faltantes

| Campo                           | Quantidade |
| ------------------------------- | ---------- |
| Protocolos sem Assunto          | 1.002      |
| Protocolos sem Projeto          | 3          |
| Protocolos sem Remetente        | 95.022     |
| Movimentações sem Setor Origem  | 0          |
| Movimentações sem Setor Destino | 0          |

#### Anomalias Detectadas

| Tipo                             | Quantidade |
| -------------------------------- | ---------- |
| Datas no Futuro (>2030)          | 91         |
| Datas no Passado (<1990)         | 1          |
| LOTE PAGAMENTOS sem Movimentação | 57.715     |

---

## 4. Setores Desabilitados com Protocolos Pendentes

### Problema Identificado

23 setores desabilitados ainda possuem protocolos "Em Andamento", totalizando **48.730 protocolos** presos.

### Top 10 Setores Afetados

| Setor                                                       | Código | Protocolos |
| ----------------------------------------------------------- | ------ | ---------- |
| DESABILITADO GERÊNCIA DE ADMINISTRAÇÃO                      | 6      | 18.953     |
| DESABILITADO GERÊNCIA ADMINISTRATIVA E FINANCEIRA           | 42     | 11.262     |
| DESABILITADO GERÊNCIA DE PROJETOS E RELAÇÕES INSTITUCIONAIS | 12     | 5.552      |
| DESABILITADO COORDENAÇÃO DE RECURSOS HUMANOS                | 36     | 5.029      |
| DESABILITADO COORDENAÇÃO DE ADM DE PROJ E CONVÊNIOS         | 24     | 4.075      |
| DESABILITADO SECRETARIA DA SUPERITENDENCIA                  | 17     | 1.245      |
| DESABILITADO COORD DE BOLSAS, EST E PREST DE SERVIÇOS       | 21     | 1.002      |
| DESABILITADO COORDENAÇÃO DE FINANÇAS                        | 34     | 618        |
| COORDENAÇÃO DE CONTABILIDADE                                | 27     | 298        |
| DESABILITADO CONTABILIDADE UFPI                             | 32     | 250        |

---

## 5. Campos Adicionados à Query de Protocolos

### Arquivo Modificado

`lib/queries/protocolos.ts`

### Novos Campos no SELECT

```sql
-- Código do setor atual (numérico)
vp.setor_atual AS setorAtualCodigo,

-- Código do setor de origem inicial
vp.setor_origem_inicial AS setorOrigemCodigo,

-- Dias desde a última movimentação
DATEDIFF(DAY, vp.dt_ultima_movimentacao, GETDATE()) AS diasSemMovimentacao,

-- Flag de estagnação (1 = estagnado, 0 = normal)
CASE
    WHEN vp.status_protocolo = 'Em Andamento'
         AND DATEDIFF(DAY, vp.dt_ultima_movimentacao, GETDATE()) > 365 THEN 1
    ELSE 0
END AS estagnado
```

### Tipos Atualizados

`types/protocolo.ts`:

```typescript
interface Protocolo {
  // ... campos existentes ...
  setorAtualCodigo?: number;
  setorOrigemCodigo?: number;
  diasSemMovimentacao?: number;
  estagnado?: boolean | number;
}
```

---

## 6. Correção: withBaseCTE no Endpoint de Qualidade

### Problema

Queries que acessam `vw_ProtocolosFinanceiro` falhavam com erro:

```
Invalid object name 'vw_ProtocolosFinanceiro'
```

### Solução

Adicionado `withBaseCTE()` nas queries que acessam a view:

- `querySetores` → `withBaseCTE(querySetoresInner)`
- `querySetoresDesabilitados` → `withBaseCTE(querySetoresDesabilitadosInner)`
- `queryEstagnacao` → `withBaseCTE(queryEstagnacaoInner)`

---

## 7. Exclusão Automática de LOTE DE PAGAMENTOS

### Justificativa

- LOTE DE PAGAMENTOS representa **29.7%** dos protocolos (52.251 registros)
- São protocolos auto-gerados pelo sistema para processamento em lote
- Não possuem tramitação real entre setores
- O próprio sistema SAGI os exclui em suas consultas

### Implementação

Por padrão, `excluirLotePagamento=true` adiciona as condições:

```sql
AND d.assunto <> 'LOTE DE PAGAMENTOS'
AND d.assunto NOT LIKE '%LOTE%PAGAMENTO%'
```

---

## 8. Resumo de Arquivos Modificados/Criados

### Arquivos Criados

| Arquivo                                  | Descrição                             |
| ---------------------------------------- | ------------------------------------- |
| `app/api/protocolos/estagnados/route.ts` | Endpoint de protocolos estagnados     |
| `app/api/admin/qualidade-dados/route.ts` | Endpoint de estatísticas de qualidade |

### Arquivos Modificados

| Arquivo                         | Alteração                       |
| ------------------------------- | ------------------------------- |
| `lib/queries/filter-builder.ts` | Novos filtros e condições       |
| `lib/queries/protocolos.ts`     | Novos campos na query principal |
| `lib/schemas/protocolos.ts`     | Schemas Zod com novos campos    |
| `app/api/protocolos/route.ts`   | Extração de novos parâmetros    |
| `types/protocolo.ts`            | Interface com novos campos      |

---

## 9. Testes Realizados

### Build

```bash
npm run build
# ✅ Build concluído com sucesso
```

### Endpoints Testados

| Endpoint                                 | Status | Resultado                    |
| ---------------------------------------- | ------ | ---------------------------- |
| `/api/protocolos/estagnados`             | ✅ OK  | 66.084 protocolos >365 dias  |
| `/api/protocolos/estagnados?resumo=true` | ✅ OK  | Estatísticas completas       |
| `/api/admin/qualidade-dados`             | ✅ OK  | Todas as métricas retornadas |
| `/api/protocolos?apenasEstagnados=true`  | ✅ OK  | 66.084 protocolos            |
| `/api/protocolos?setorAtual=5`           | ✅ OK  | 117 protocolos no Jurídico   |

---

## 10. Próximos Passos Sugeridos

1. **Interface de Administração**: Criar página para visualizar estatísticas de qualidade
2. **Dashboard de Estagnação**: Gráficos de protocolos estagnados por setor/faixa
3. **Alertas**: Notificações para protocolos estagnados há muito tempo
4. **Migração de Setores**: Mover protocolos de setores desabilitados para ativos
5. **Limpeza de Dados**: Corrigir registros com `codSituacaoProt = NULL`

---

_Relatório gerado em 05/01/2026_
_Sistema: Portal FADEX - Acompanhamento de Protocolos_

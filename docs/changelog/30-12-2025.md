# Relatório de Alterações - 30/12/2025

## Resumo

Implementação da funcionalidade de visualização de relacionamentos entre protocolos (Mãe/Filho) no Dashboard de Acompanhamento de Protocolos.

---

## Funcionalidades Implementadas

### 1. Componente de Relacionamentos de Protocolos

**Arquivo criado:** `components/protocolo/RelacionamentosProtocolo.tsx`

Novo componente que exibe:

- **Protocolos Mãe (Origem):** Protocolos dos quais o atual foi derivado/desmembrado
- **Protocolos Filhos (Derivados):** Protocolos que foram originados a partir do atual
- **Árvore de Relacionamentos:** Visualização hierárquica navegável de toda a cadeia de relacionamentos

Características:

- Cards informativos com data do vínculo e valor associado (quando aplicável)
- Links para navegação direta entre protocolos relacionados
- Indicadores visuais diferenciando protocolos mãe e filho
- Suporte flexível para dados em camelCase e PascalCase

---

### 2. Indicadores na Listagem de Protocolos

**Arquivo modificado:** `components/tables/columns.tsx`

Adicionados badges visuais na coluna "Número" da tabela de protocolos:

| Indicador       | Ícone            | Descrição                                   |
| --------------- | ---------------- | ------------------------------------------- |
| Protocolo Mãe   | GitBranch (azul) | Mostra quantidade de filhos derivados       |
| Protocolo Filho | GitMerge (roxo)  | Indica que foi originado de outro protocolo |

- Tooltip explicativo ao passar o mouse sobre o badge
- Cores diferenciadas para fácil identificação

---

### 3. Nova Aba "Vínculos" na Página de Detalhes

**Arquivo modificado:** `app/(dashboard)/protocolos/[id]/page.tsx`

- Adicionada quinta aba "Vínculos" no sistema de tabs
- Badge com contador de relacionamentos no header da página
- Integração completa com o componente `RelacionamentosProtocolo`

---

### 4. Query de Protocolos Atualizada

**Arquivo modificado:** `lib/queries/protocolos.ts`

Adicionados novos campos na consulta principal:

```sql
-- Quantidade de protocolos filhos (é protocolo mãe)
(SELECT COUNT(*) FROM scd_movimentacaoItem smi
 WHERE smi.CodProt = vp.codprot AND smi.CodProtRel IS NOT NULL
 AND (smi.deletado IS NULL OR smi.deletado = 0)) AS qtdFilhos

-- Indica se é filho de outro protocolo
(SELECT COUNT(*) FROM scd_movimentacaoItem smi
 WHERE smi.CodProtRel = vp.codprot
 AND (smi.deletado IS NULL OR smi.deletado = 0)) AS ehFilhoDe
```

---

### 5. Tipos TypeScript Atualizados

**Arquivo modificado:** `types/protocolo.ts`

Adicionados campos na interface `Protocolo`:

```typescript
// Indicadores de relacionamento Mãe/Filho
qtdFilhos?: number;   // Quantidade de protocolos filhos
ehFilhoDe?: number;   // Quantidade de protocolos mãe
```

---

## Correções de Bugs

### Conflito de Nomenclatura PascalCase vs camelCase

**Problema:** Os tipos TypeScript usavam camelCase, mas algumas respostas do SQL Server retornavam PascalCase, causando erros de tipo no build.

**Solução:** Implementado padrão flexível com função helper `getValue()` nos componentes:

```typescript
function getValue<T>(obj: Record<string, unknown>, camelKey: string, pascalKey: string): T {
  return (obj[camelKey] ?? obj[pascalKey]) as T;
}
```

**Arquivos corrigidos:**

- `components/protocolo/LancamentosFinanceiros.tsx`
- `components/protocolo/ResumoTramitacao.tsx`
- `components/protocolo/DadosEnriquecidos.tsx`
- `components/protocolo/RelacionamentosProtocolo.tsx`
- `app/api/protocolos/[id]/completo/route.ts`

---

## Arquivos Modificados

| Arquivo                                             | Tipo de Alteração                     |
| --------------------------------------------------- | ------------------------------------- |
| `components/protocolo/RelacionamentosProtocolo.tsx` | **Criado**                            |
| `components/protocolo/index.ts`                     | Adicionado export                     |
| `components/protocolo/LancamentosFinanceiros.tsx`   | Corrigido tipos flexíveis             |
| `components/protocolo/ResumoTramitacao.tsx`         | Corrigido tipos flexíveis             |
| `components/protocolo/DadosEnriquecidos.tsx`        | Corrigido tipos flexíveis             |
| `components/tables/columns.tsx`                     | Adicionado indicadores Mãe/Filho      |
| `app/(dashboard)/protocolos/[id]/page.tsx`          | Adicionada aba Vínculos               |
| `app/api/protocolos/[id]/completo/route.ts`         | Corrigido tipos e tipagem             |
| `lib/queries/protocolos.ts`                         | Adicionado campos relacionamento      |
| `types/protocolo.ts`                                | Adicionado campos qtdFilhos/ehFilhoDe |

---

## Dependências Utilizadas

Nenhuma nova dependência foi adicionada. Utilizados recursos já existentes:

- `lucide-react` (ícones GitBranch, GitMerge, ChevronRight)
- `@/components/ui/*` (shadcn/ui components)
- `date-fns` (formatação de datas)

---

## Como Testar

1. Acesse a listagem de protocolos em `/protocolos`
2. Observe os badges indicadores na coluna "Número"
3. Clique em um protocolo que tenha indicador de relacionamento
4. Na página de detalhes, acesse a aba "Vínculos"
5. Navegue entre protocolos relacionados clicando nos links

---

## Status

- Build: **Sucesso**
- Servidor: **Rodando em http://localhost:3001**
- Testes: Pendente validação manual

---

_Relatório gerado automaticamente em 30/12/2025_
